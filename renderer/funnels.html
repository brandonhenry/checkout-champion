<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Funnels</title>
    <link rel="icon" href="../favicon.png" type="image/png" sizes="any">
    <link rel="stylesheet" href="styles.css" />
    <style>
      body{ padding: 16px; }
      .funnels-layout{ display: grid; grid-template-columns: 360px 1fr 360px; gap: 16px; align-items: stretch; }
      .funnels-list{ background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 12px; box-shadow: var(--shadow); overflow: auto; }
      .funnels-list .search{ position: sticky; top: 0; background: linear-gradient(180deg, rgba(11,15,20,0.96), rgba(11,15,20,0.86)); backdrop-filter: blur(6px); margin: -12px -12px 8px; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.08); border-top-left-radius: 14px; border-top-right-radius: 14px; display: flex; gap: 8px; align-items: center; }
      .funnels-list .search input{ width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.02); color: var(--text); }
      .funnels-list .search .btn{ padding: 8px 10px; }
      .funnel-item{ display: grid; grid-template-columns: 1fr; gap: 4px; align-items: center; padding: 8px; border-radius: 10px; cursor: pointer; }
      .funnel-item:hover{ background: rgba(255,255,255,0.06); }
      .funnel-item h4{ margin: 0; font-size: 14px; }
      .funnel-item p{ margin: 0; color: var(--subtle); font-size: 12px; }
      .viewer-card{ background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 12px; box-shadow: var(--shadow); display: grid; grid-template-rows: auto 1fr; gap: 8px; }
      .viewer-actions{ display: flex; gap: 8px; }
      .viewer-webview{ border-radius: 12px; overflow: hidden; background: #fff; min-height: 640px; }
      .inspector-card{ background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.12); border-radius: 14px; padding: 12px; box-shadow: var(--shadow); display: grid; grid-template-rows: auto 1fr; gap: 8px; position: sticky; top: 16px; height: fit-content; max-height: calc(100vh - 48px); }
      .inspector-header{ display: grid; grid-template-columns: 1fr auto; gap: 6px; align-items: center; }
      .inspector-title{ font-weight: 800; font-size: 18px; margin: 0; }
      .inspector-sub{ color: var(--subtle); font-size: 12px; }
      .meta-list{ overflow: auto; display: grid; gap: 8px; padding-right: 4px; }
      .meta-row{ display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; padding: 10px 12px; border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; background: rgba(255,255,255,0.04); }
      .meta-row:hover{ background: rgba(255,255,255,0.06); }
      .meta-label{ color: var(--subtle); font-size: 11px; font-weight: 600; letter-spacing: 0.4px; text-transform: uppercase; }
      .meta-value{ font-size: 18px; font-weight: 800; word-break: break-all; }
      .copy-btn{ padding: 8px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: var(--text); cursor: pointer; }
      .copy-btn:hover{ background: rgba(255,255,255,0.1); }
      .funnels-layout.left-collapsed{ grid-template-columns: 1fr 360px; }
      .funnels-layout.right-collapsed{ grid-template-columns: 360px 1fr; }
      .funnels-layout.left-collapsed .funnels-list{ display: none; }
      .funnels-layout.right-collapsed .inspector-card{ display: none; }
      .funnels-layout.left-collapsed.right-collapsed{ grid-template-columns: 1fr; }
      .edge-toggle{ position: fixed; top: 16px; z-index: 1000; opacity: 0.9; }
      .edge-toggle.left{ left: 16px; }
      .edge-toggle.right{ right: 16px; }
      @media (max-width: 1200px){ .funnels-layout{ grid-template-columns: 1fr; } .inspector-card{ position: relative; top: auto; max-height: none; } }
    </style>
  </head>
  <body>
    <div class="funnels-layout">
      <div class="funnels-list">
        <div class="search">
          <input id="search" type="search" placeholder="Search by name, user, domain, or ID" autocomplete="off" />
          <button id="collapse-left" class="btn ghost" title="Hide left sidebar">Hide</button>
        </div>
        <div id="list"></div>
      </div>
      <div class="viewer-card">
        <div class="viewer-actions">
          <button id="open-live" class="btn">View Live</button>
          <button id="open-edit" class="btn">Edit Funnel</button>
          <button id="open-external" class="btn">Open Current in Browser</button>
        </div>
        <div class="viewer-webview">
          <webview id="viewer" allowpopups style="width:100%; height:100%; background:#fff;"></webview>
        </div>
      </div>
      <div class="inspector-card">
        <div class="inspector-header">
          <h3 class="inspector-title" id="inspector-title">Funnel</h3>
          <div class="inspector-sub" id="inspector-sub"></div>
          <button id="collapse-right" class="btn ghost" title="Hide right sidebar">Hide</button>
        </div>
        <div class="meta-list" id="inspector"></div>
      </div>
    </div>
    <button id="expand-left" class="btn ghost edge-toggle left" hidden>Show List</button>
    <button id="expand-right" class="btn ghost edge-toggle right" hidden>Show Inspector</button>
    <script>
      (async function(){
        const list = document.getElementById('list');
        const search = document.getElementById('search');
        const viewer = document.getElementById('viewer');
        const btnLive = document.getElementById('open-live');
        const btnEdit = document.getElementById('open-edit');
        const btnExt = document.getElementById('open-external');
        const funnels = await window.funnels.get();
        let selected = null;
        let query = '';
        const inspector = document.getElementById('inspector');
        const inspectorTitle = document.getElementById('inspector-title');
        const inspectorSub = document.getElementById('inspector-sub');
        const layout = document.querySelector('.funnels-layout');
        const btnCollapseLeft = document.getElementById('collapse-left');
        const btnCollapseRight = document.getElementById('collapse-right');
        const btnExpandLeft = document.getElementById('expand-left');
        const btnExpandRight = document.getElementById('expand-right');
        const LS_LEFT = 'funnels:leftCollapsed';
        const LS_RIGHT = 'funnels:rightCollapsed';
        let leftCollapsed = false;
        let rightCollapsed = false;
        try { const v = localStorage.getItem(LS_LEFT); if (v !== null) leftCollapsed = JSON.parse(v); } catch {}
        try { const v = localStorage.getItem(LS_RIGHT); if (v !== null) rightCollapsed = JSON.parse(v); } catch {}
        function applySidebarState(){
          if (!layout) return;
          layout.classList.toggle('left-collapsed', !!leftCollapsed);
          layout.classList.toggle('right-collapsed', !!rightCollapsed);
          if (btnExpandLeft) btnExpandLeft.hidden = !leftCollapsed;
          if (btnExpandRight) btnExpandRight.hidden = !rightCollapsed;
        }
        applySidebarState();
        btnCollapseLeft?.addEventListener('click', () => {
          leftCollapsed = true; applySidebarState(); try { localStorage.setItem(LS_LEFT, JSON.stringify(true)); } catch {}
        });
        btnCollapseRight?.addEventListener('click', () => {
          rightCollapsed = true; applySidebarState(); try { localStorage.setItem(LS_RIGHT, JSON.stringify(true)); } catch {}
        });
        btnExpandLeft?.addEventListener('click', () => {
          leftCollapsed = false; applySidebarState(); try { localStorage.setItem(LS_LEFT, JSON.stringify(false)); } catch {}
        });
        btnExpandRight?.addEventListener('click', () => {
          rightCollapsed = false; applySidebarState(); try { localStorage.setItem(LS_RIGHT, JSON.stringify(false)); } catch {}
        });

        function getFiltered(){
          if (!query) return funnels;
          const q = query.toLowerCase();
          return funnels.filter(f => {
            const id = (f.id || '').toString().toLowerCase();
            const name = (f.name || '').toLowerCase();
            const user = (f.user || '').toLowerCase();
            const domain = (f.domain || '').toLowerCase();
            return id.includes(q) || name.includes(q) || user.includes(q) || domain.includes(q);
          });
        }

        function render(){
          list.innerHTML = '';
          const rows = getFiltered();
          for (const f of rows){
            const item = document.createElement('div');
            item.className = 'funnel-item';
            item.innerHTML = `
              <h4>${f.name || '(no name)'} <span style="color:#9fb0c0">#${f.id || ''}</span></h4>
              <p>${f.domain || ''} ${f.pages ? '• '+f.pages+' pages' : ''}</p>
            `;
            item.addEventListener('click', () => select(f));
            list.appendChild(item);
          }
        }

        function select(f){
          selected = f;
          if (f?.liveUrl){ viewer.src = f.liveUrl; }
          updateInspectorHeader();
        }

        function updateInspectorHeader(){
          const name = selected?.name || '(no name)';
          const id = selected?.id ? `#${selected.id}` : '';
          const dom = selected?.domain ? ` • ${selected.domain}` : '';
          inspectorTitle.textContent = name;
          inspectorSub.textContent = [id, dom].filter(Boolean).join(' ');
        }

        function friendlyLabel(name){
          if (!name) return '';
          const map = {
            id: 'Funnel ID',
            name: 'Name',
            user: 'User',
            domain: 'Domain',
            pages: 'Pages',
            created: 'Created',
            published: 'Published',
            status: 'Status',
            liveUrl: 'Live URL',
          };
          if (map[name]) return map[name];
          return name
            .replace(/([a-z])([A-Z])/g, '$1 $2')
            .replace(/[_-]+/g, ' ')
            .replace(/\b\w/g, c => c.toUpperCase());
        }

        function renderInspector(){
          inspector.innerHTML = '';
          if (!selected) return;
          const entries = Object.entries(selected);
          for (const [name, value] of entries){
            if (!value) continue;
            const label = friendlyLabel(name);
            const row = document.createElement('div');
            row.className = 'meta-row';
            row.innerHTML = `
              <div>
                <div class="meta-label">${label}</div>
                <div class="meta-value">${value}</div>
              </div>
              <button class="copy-btn" title="Copy" aria-label="Copy">Copy</button>
            `;
            const copyBtn = row.querySelector('.copy-btn');
            copyBtn.addEventListener('click', async () => {
              try { await navigator.clipboard.writeText((value || '').toString()); } catch {}
            });
            row.querySelector('.meta-value').addEventListener('click', async () => {
              try { await navigator.clipboard.writeText((value || '').toString()); } catch {}
            });
            inspector.appendChild(row);
          }
        }

        async function openEditForCurrent(){
          if (!viewer) return;
          try {
            // Wait for pageDataScript to appear
            const res = await viewer.executeJavaScript(`(async () => {
              const sleep = (ms) => new Promise(r => setTimeout(r, ms));
              let tries = 0;
              while (tries++ < 40){
                const el = document.querySelector('#pageDataScript');
                if (el){
                  const txt = el.textContent || '';
                  const m = txt.match(/funnelReferenceId"\s*:\s*"([^"]+)"/);
                  const id = m ? m[1] : null;
                  return { ok: !!id, id };
                }
                await sleep(250);
              }
              return { ok: false };
            })();`);
            if (res && res.ok && res.id){
              const editUrl = `https://app.checkoutchamp.com/editfunnel/${res.id}`;
              viewer.src = editUrl;
            }
          } catch {}
        }

        search.addEventListener('input', () => {
          query = search.value.trim();
          render();
        });

        btnLive.addEventListener('click', () => { if (selected?.liveUrl) viewer.src = selected.liveUrl; });
        btnEdit.addEventListener('click', () => { openEditForCurrent(); });
        btnExt.addEventListener('click', async () => {
          try { const url = await viewer.getURL(); if (url) window.open(url, '_blank'); } catch {}
        });

        viewer.addEventListener('did-stop-loading', () => { renderInspector(); });
        viewer.addEventListener('did-navigate', () => { renderInspector(); });
        viewer.addEventListener('dom-ready', () => { renderInspector(); });

        render();
        if (funnels && funnels[0]) select(funnels[0]);
      })();
    </script>
  </body>
  </html>


